<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World Satellite Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    #map {
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
    }
    body {
      margin: 0;
      padding: 0;
    }
    .control-panel {
      position: absolute;
      z-index: 1000;
      right: 210px;
      top: 20px;
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 0px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
    }
    .mode-switch {
      margin-bottom: 0px;
      padding: 0px;
      background: rgba(240,240,240,0.8);
      border-radius: 5px;
    }
    .mode-switch button {
      display: inline-block;
      margin-right: 0px;
      cursor: pointer;
      background: none;
      border: none;
      outline: none;
      padding: 0;
      transition: box-shadow 0.2s;
    }
    .mode-switch button.selected {
      box-shadow: 0 0 0 3px #3498db;
      border-radius: 0px;
    }
    #map-panel {
      top: 95px;
      right: 10px;
      width: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .location-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .location-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 56px;
      height: 56px;
      padding: 0;
      border: none;
      border-radius: 0;
      background: none;
      cursor: pointer;
      margin: 0;
    }
    .map-btn-img {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 48px;
    }
    .map-btn-img img {
      width: 48px;
      height: 48px;
      display: block;
    }
    .map-btn-num {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.3em;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 4px #000, 0 0 2px #333;
      pointer-events: none;
    }
    .location-btn.memorize-mode {
      background-color: #e74c3c;
      color: white;
    }
    .location-btn.memorize-mode:hover {
      background-color: #c0392b;
    }
    .location-btn.go-mode {
      background-color: #3498db;
      color: white;
    }
    .location-btn.go-mode:hover {
      background-color: #2980b9;
    }
    .other-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
      margin-top: 10px;
    }
    .other-buttons button {
      display: flex;
      align-items: center;
      width: 48px;
      height: 48px;
      padding: 0;
      border: none;
      border-radius: 0px;
      background: none;
      cursor: pointer;
    }
    .other-buttons button:hover {
      background-color: #7f8c8d;
    }
    #drawing-panel {
      top: 95px;
      right: 85px;
      width: 32px;
    }
    #mode-panel {
      top: 10px;
      right: 10px;
      width: 100px;
    }
  </style>
</head>
<body>
  <div class="control-panel" id="drawing-panel">
    <div class="other-buttons">
      <button id="draw-btn" style="padding:0;border:none;background:none;">
        <img id="draw-btn-img" src="image/iconDrawingG.jpg" alt="Freehand Draw" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="clear-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconClearG.jpg" alt="Clear Drawings" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="measure-btn" style="padding:0;border:none;background:none;">
        <img id="measure-btn-img" src="image/IconRulerG.jpg" alt="Measure Distance" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="tank-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconTankG.jpg" alt="Tank Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="car-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconUAVG.jpg" alt="Car Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="house-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconJetFighterG.jpg" alt="House Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
    </div>
  </div>
  <div class="control-panel" id="map-panel">
    <div class="location-buttons">
      <button class="location-btn" id="location-1"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-1" style="width:48px;height:48px;"><span class="map-btn-num" id="location-num-1">1</span></span></button>
      <button class="location-btn" id="location-2"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-2" style="width:48px;height:48px;"><span class="map-btn-num" id="location-num-2">2</span></span></button>
      <button class="location-btn" id="location-3"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-3" style="width:48px;height:48px;"><span class="map-btn-num" id="location-num-3">3</span></span></button>
      <button class="location-btn" id="location-4"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-4" style="width:48px;height:48px;"><span class="map-btn-num" id="location-num-4">4</span></span></button>
      <button class="location-btn" id="location-5"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-5" style="width:48px;height:48px;"><span class="map-btn-num" id="location-num-5">5</span></span></button>
    </div>
  </div>
  <div class="control-panel" id="mode-panel">
    <div class="mode-switch">
      <button id="mode-memorize" style="padding:0;border:none;background:none;outline:none;">
        <img id="mode-memorize-img" src="image/IconSaveL.jpg" alt="Memorize Mode" style="width:40px;height:40px;vertical-align:middle;">
      </button>
      <button id="mode-go" style="padding:0;border:none;background:none;outline:none;">
        <img id="mode-go-img" src="image/IconGotoMapG.jpg" alt="Go Mode" style="width:40px;height:40px;vertical-align:middle;">
      </button>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    // Map setup
    var map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(map);

    // Freehand drawing setup
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    
    // Freehand drawing variables
    var isDrawing = false;
    var currentPath = [];
    var drawingMode = false;
    
    // Freehand drawing functions
    function startFreehandDraw() {
      drawingMode = true;
      map.getContainer().style.cursor = 'crosshair';
      map.dragging.disable();
      map.doubleClickZoom.disable();
      map.scrollWheelZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
    }
    
    function stopFreehandDraw() {
      drawingMode = false;
      isDrawing = false;
      currentPath = [];
      map.getContainer().style.cursor = '';
      map.dragging.enable();
      map.doubleClickZoom.enable();
      map.scrollWheelZoom.enable();
      map.boxZoom.enable();
      map.keyboard.enable();
    }
    
    function clearAllDrawings() {
      drawnItems.clearLayers();
      if (measureLine) { map.removeLayer(measureLine); measureLine = null; }
      measureMarkers.forEach(m => map.removeLayer(m));
      measureMarkers = [];
      if (measureTooltip) { map.removeLayer(measureTooltip); measureTooltip = null; }
      measurePoints = [];
    }
    
    // Mouse event handlers for freehand drawing
    map.on('mousedown', function(e) {
      if (!drawingMode) return;
      isDrawing = true;
      currentPath = [e.latlng];
    });
    
    map.on('mousemove', function(e) {
      if (!drawingMode || !isDrawing) return;
      currentPath.push(e.latlng);
      
      // Create temporary polyline for visual feedback
      if (currentPath.length > 1) {
        // Remove previous temporary line
        map.eachLayer(function(layer) {
          if (layer.options && layer.options.temp) {
            map.removeLayer(layer);
          }
        });
        
        // Add new temporary line
        L.polyline(currentPath, {
          color: '#ff0000',
          weight: 3,
          opacity: 0.7,
          temp: true
        }).addTo(map);
      }
    });
    
    map.on('mouseup', function(e) {
      if (!drawingMode || !isDrawing) return;
      isDrawing = false;
      
      if (currentPath.length > 1) {
        // Remove temporary line
        map.eachLayer(function(layer) {
          if (layer.options && layer.options.temp) {
            map.removeLayer(layer);
          }
        });
        
        // Add final polyline to drawn items
        var finalLine = L.polyline(currentPath, {
          color: '#ff0000',
          weight: 3,
          opacity: 1
        });
        drawnItems.addLayer(finalLine);
      }
      
      currentPath = [];
    });
    
    // Touch event handlers for mobile devices
    map.on('touchstart', function(e) {
      if (!drawingMode) return;
      e.originalEvent.preventDefault();
      isDrawing = true;
      var touch = e.originalEvent.touches[0];
      var latlng = map.containerPointToLatLng([touch.clientX, touch.clientY]);
      currentPath = [latlng];
    });
    
    map.on('touchmove', function(e) {
      if (!drawingMode || !isDrawing) return;
      e.originalEvent.preventDefault();
      var touch = e.originalEvent.touches[0];
      var latlng = map.containerPointToLatLng([touch.clientX, touch.clientY]);
      currentPath.push(latlng);
      
      if (currentPath.length > 1) {
        map.eachLayer(function(layer) {
          if (layer.options && layer.options.temp) {
            map.removeLayer(layer);
          }
        });
        
        L.polyline(currentPath, {
          color: '#ff0000',
          weight: 3,
          opacity: 0.7,
          temp: true
        }).addTo(map);
      }
    });
    
    map.on('touchend', function(e) {
      if (!drawingMode || !isDrawing) return;
      e.originalEvent.preventDefault();
      isDrawing = false;
      
      if (currentPath.length > 1) {
        map.eachLayer(function(layer) {
          if (layer.options && layer.options.temp) {
            map.removeLayer(layer);
          }
        });
        
        var finalLine = L.polyline(currentPath, {
          color: '#ff0000',
          weight: 3,
          opacity: 1
        });
        drawnItems.addLayer(finalLine);
      }
      
      currentPath = [];
    });

    // Button logic
    document.getElementById('draw-btn').onclick = function() {
      var img = document.getElementById('draw-btn-img');
      if (drawingMode) {
        stopFreehandDraw();
        img.src = 'image/iconDrawingG.jpg';
        img.alt = 'Freehand Draw';
        this.style.backgroundColor = '#95a5a6';
      } else {
        startFreehandDraw();
        img.src = 'image/iconDrawingL.jpg';
        img.alt = 'Stop Drawing';
        this.style.backgroundColor = '#e74c3c';
      }
    };
    
    document.getElementById('clear-btn').onclick = function() {
      clearAllDrawings();
      if (drawingMode) {
        stopFreehandDraw();
        document.getElementById('draw-btn').textContent = 'Freehand Draw';
        document.getElementById('draw-btn').style.backgroundColor = '#95a5a6';
      }
    };
    
    // Icon definitions
    var tankIcon = L.icon({
      iconUrl: 'image/IconTankG.jpg',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
    var carIcon = L.icon({
      iconUrl: 'image/IconUAVG.jpg',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
    var houseIcon = L.icon({
      iconUrl: 'image/IconJetFighterG.jpg',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    // Place icon logic
    var placeMode = null;
    function setPlaceMode(mode) {
      placeMode = mode;
      map.getContainer().style.cursor = 'crosshair';
    }
    function clearPlaceMode() {
      placeMode = null;
      map.getContainer().style.cursor = '';
    }
    document.getElementById('tank-btn').onclick = function() { setPlaceMode('tank'); };
    document.getElementById('car-btn').onclick = function() { setPlaceMode('car'); };
    document.getElementById('house-btn').onclick = function() { setPlaceMode('house'); };

    map.on('click', function(e) {
      if (!placeMode) return;
      var icon;
      if (placeMode === 'tank') icon = tankIcon;
      if (placeMode === 'car') icon = carIcon;
      if (placeMode === 'house') icon = houseIcon;
      L.marker(e.latlng, {icon: icon}).addTo(map);
      clearPlaceMode();
    });

    // Memorize and go to location logic
    // Load memorized locations from localStorage
    function loadMemorized() {
      try {
        const saved = localStorage.getItem('memorizedLocations');
        if (saved) {
          const arr = JSON.parse(saved);
          // Convert center back to LatLng objects
          return arr.map(loc => {
            if (!loc) return null;
            return {
              ...loc,
              center: L.latLng(loc.center.lat, loc.center.lng)
            };
          });
        }
      } catch (e) {}
      return [null, null, null, null, null];
    }

    function saveMemorized() {
      localStorage.setItem('memorizedLocations', JSON.stringify(memorized));
    }

    var memorized = loadMemorized();
    var currentMode = 'memorize'; // Default to memorize mode
    
    // Function to get elevation from coordinates
    async function getElevation(lat, lng) {
      try {
        // Using Open-Elevation API (free service)
        const response = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
        const data = await response.json();
        if (data.results && data.results.length > 0) {
          return data.results[0].elevation;
        }
        return null;
      } catch (error) {
        console.log('Elevation service unavailable, using map zoom as approximation');
        // Fallback: approximate elevation based on zoom level (very rough estimate)
        const zoom = map.getZoom();
        return Math.max(0, (20 - zoom) * 100); // Rough approximation
      }
    }
    
    async function memorize(idx) {
      const center = map.getCenter();
      const zoom = map.getZoom();
      
      // Show loading message
      const loadingMsg = document.createElement('div');
      loadingMsg.textContent = 'Getting elevation data...';
      loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:10px;border-radius:5px;z-index:9999;';
      document.body.appendChild(loadingMsg);
      
      try {
        const elevation = await getElevation(center.lat, center.lng);
        memorized[idx] = {
          center: center,
          zoom: zoom,
          elevation: elevation,
          timestamp: new Date().toLocaleString()
        };
        saveMemorized();
        document.body.removeChild(loadingMsg);
        const elevationText = elevation !== null ? `${Math.round(elevation)}m` : 'Unknown';
        alert(`Location ${idx+1} memorized!\nCoordinates: ${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}\nElevation: ${elevationText}\nZoom: ${zoom}`);
        updateLocationButtons(); // Update button appearance
      } catch (error) {
        document.body.removeChild(loadingMsg);
        alert('Error getting elevation data. Location saved without elevation.');
        memorized[idx] = {
          center: center,
          zoom: zoom,
          elevation: null,
          timestamp: new Date().toLocaleString()
        };
        saveMemorized();
        updateLocationButtons();
      }
    }
    
    function goTo(idx) {
      if (!memorized[idx]) {
        alert('No location memorized for '+(idx+1));
        return;
      }
      const target = memorized[idx];
      const elevationText = target.elevation !== null ? `${Math.round(target.elevation)}m` : 'Unknown';
      alert(`Going to Location ${idx+1}\nCoordinates: ${target.center.lat.toFixed(6)}, ${target.center.lng.toFixed(6)}\nElevation: ${elevationText}\nSaved: ${target.timestamp}`);

      // Preload tiles for smoother fly-in
      preloadTiles(target.center, target.zoom).then(() => {
        map.setView(target.center, target.zoom, {animate: true, duration: 2});
      });
    }

    // Preload tiles for a given center and zoom
    function preloadTiles(center, zoom) {
      return new Promise(resolve => {
        // Calculate tile coordinates for the center
        var tileSize = 256;
        var crs = map.options.crs;
        var tileCoords = crs.project(center);
        var scale = crs.scale(zoom);
        var tileX = Math.floor(tileCoords.x * scale / tileSize);
        var tileY = Math.floor(tileCoords.y * scale / tileSize);

        // Preload a 3x3 grid of tiles around the center
        var promises = [];
        for (var dx = -1; dx <= 1; dx++) {
          for (var dy = -1; dy <= 1; dy++) {
            var x = tileX + dx;
            var y = tileY + dy;
            var url = map._layers[Object.keys(map._layers)[0]]._url
              .replace('{z}', zoom)
              .replace('{x}', x)
              .replace('{y}', y);
            promises.push(fetch(url).catch(()=>{}));
          }
        }
        Promise.all(promises).then(() => setTimeout(resolve, 200)); // Wait a bit for browser cache
      });
    }
    
    function showAllLocations() {
      let locationList = 'Memorized Locations:\n\n';
      let hasLocations = false;
      
      for (let i = 0; i < 5; i++) {
        if (memorized[i]) {
          hasLocations = true;
          const loc = memorized[i];
          const elevationText = loc.elevation !== null ? `${Math.round(loc.elevation)}m` : 'Unknown';
          locationList += `Map ${i+1}:\n`;
          locationList += `  Coordinates: ${loc.center.lat.toFixed(6)}, ${loc.center.lng.toFixed(6)}\n`;
          locationList += `  Elevation: ${elevationText}\n`;
          locationList += `  Zoom Level: ${loc.zoom}\n`;
          locationList += `  Saved: ${loc.timestamp}\n\n`;
        }
      }
      
      if (!hasLocations) {
        alert('No locations have been memorized yet.');
      } else {
        alert(locationList);
      }
    }
    
    function updateLocationButtons() {
      for (let i = 1; i <= 5; i++) {
        const btn = document.getElementById('location-' + i);
        const img = document.getElementById('location-img-' + i);
        const isMemorized = memorized[i-1] !== null;
        if (currentMode === 'memorize') {
          img.src = 'image/IconMapR.jpg';
        } else {
          img.src = isMemorized ? 'image/IconMapL.jpg' : 'image/IconMapG.jpg';
        }
        btn.className = 'location-btn';
        btn.style.opacity = currentMode === 'go' && !isMemorized ? '0.5' : '1';
      }
      saveMemorized(); // Save state on every update
    }
    
    function handleLocationClick(index) {
      if (currentMode === 'memorize') {
        memorize(index);
      } else {
        goTo(index);
      }
    }
    
    // Set up location button event listeners
    for (let i = 1; i <= 5; i++) {
      document.getElementById('location-' + i).onclick = function() {
        handleLocationClick(i - 1);
      };
    }
    
    // Mode switch icon logic
    function setMode(mode) {
      currentMode = mode;
      updateLocationButtons();
      // Update icons
      if (mode === 'memorize') {
        document.getElementById('mode-memorize').classList.add('selected');
        document.getElementById('mode-go').classList.remove('selected');
        document.getElementById('mode-memorize-img').src = 'image/IconSaveL.jpg';
        document.getElementById('mode-go-img').src = 'image/IconGotoMapG.jpg';
      } else {
        document.getElementById('mode-go').classList.add('selected');
        document.getElementById('mode-memorize').classList.remove('selected');
        document.getElementById('mode-memorize-img').src = 'image/IconSaveG.jpg';
        document.getElementById('mode-go-img').src = 'image/IconGotoMapL.jpg';
      }
    }

    document.getElementById('mode-memorize').onclick = function() { setMode('memorize'); };
    document.getElementById('mode-go').onclick = function() { setMode('go'); };

    // Measuring tool variables
    var measuring = false;
    var measurePoints = [];
    var measureLine = null;
    var measureMarkers = [];
    var measureTooltip = null;

    function startMeasuring() {
      measuring = true;
      measurePoints = [];
      if (measureLine) { map.removeLayer(measureLine); measureLine = null; }
      measureMarkers.forEach(m => map.removeLayer(m));
      measureMarkers = [];
      if (measureTooltip) { map.removeLayer(measureTooltip); measureTooltip = null; }
      map.getContainer().style.cursor = 'crosshair';
    }

    function stopMeasuring() {
      measuring = false;
      map.getContainer().style.cursor = '';
    }

    function updateMeasure() {
      if (measureLine) { map.removeLayer(measureLine); measureLine = null; }
      measureMarkers.forEach(m => map.removeLayer(m));
      measureMarkers = [];
      if (measurePoints.length > 1) {
        measureLine = L.polyline(measurePoints, {color: 'orange', weight: 4, dashArray: '6,6'}).addTo(map);
      }
      measurePoints.forEach((pt, i) => {
        var marker = L.circleMarker(pt, {radius: 6, color: 'orange', fillColor: 'white', fillOpacity: 1, weight: 2}).addTo(map);
        measureMarkers.push(marker);
      });
      // Tooltip for total distance
      if (measureTooltip) { map.removeLayer(measureTooltip); measureTooltip = null; }
      if (measurePoints.length > 1) {
        var dist = 0;
        for (var i=1; i<measurePoints.length; i++) {
          dist += map.distance(measurePoints[i-1], measurePoints[i]);
        }
        var last = measurePoints[measurePoints.length-1];
        var distText = dist >= 1000 ? (dist/1000).toFixed(2) + ' km' : dist.toFixed(1) + ' m';
        measureTooltip = L.popup({closeButton:false, autoClose:false})
          .setLatLng(last)
          .setContent('<b>Total: ' + distText + '</b>')
          .addTo(map);
      }
    }

    document.getElementById('measure-btn').onclick = function() {
      var img = document.getElementById('measure-btn-img');
      if (measuring) {
        stopMeasuring();
        img.src = 'image/IconRulerG.jpg';
        img.alt = 'Measure Distance';
        this.style.backgroundColor = '#95a5a6';
        // Do NOT clear measurement visuals here
      } else {
        startMeasuring();
        img.src = 'image/IconRulerL.jpg';
        img.alt = 'Stop Measuring';
        this.style.backgroundColor = '#e67e22';
      }
    };

    map.on('click', function(e) {
      if (measuring) {
        measurePoints.push(e.latlng);
        updateMeasure();
      }
    });

    map.on('dblclick', function(e) {
      if (measuring) {
        stopMeasuring();
        document.getElementById('measure-btn').textContent = 'Measure Distance';
        document.getElementById('measure-btn').style.backgroundColor = '#95a5a6';
        // Do NOT clear measurement visuals here
      }
    });

    // Initialize button appearance
    updateLocationButtons();
  </script>
</body>
</html>
