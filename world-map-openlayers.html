<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>World Map (OpenLayers)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css" />
  <style>
    /* Base layout */
    html, body { margin: 0; padding: 0; height: 100%; }
  #map { width: 100vw; height: 100vh; margin: 0; padding: 0; background: #111; }

    /* Panels copied/adapted from world-satellite-map.html */
    .control-panel {
      position: absolute;
      z-index: 1000;
      right: 400px;
      top: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      margin: 0;
      user-select: none;
    }
    #drawing-panel { top: 80px; right: 70px; width: 32px; }
    #mode-panel { top: 10px; right: 10px; width: 92px; }
    #tools-panel { top: 235px; right: 70px; width: 32px; }
    #map-panel { top: 80px; right: 10px; width: 50px; padding: 0; }
    #map-panel .location-buttons { display: block; flex-direction: column; align-items: center; gap: 40px; margin: 0; padding: 0; align-items: center; justify-content: center; }
    #map-panel .location-btn { width: 50px; height: 50px; padding: 0; border: none; background: none; display: flex; align-items: center; justify-content: center; }

    .map-btn-img { position: relative; display: inline-block; width: 32px; height: 32px; }
    .map-btn-img img { width: 32px; height: 32px; display: block; }
    .map-btn-num { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.3em; font-weight: bold; color: white; text-shadow: 0 0 4px #000, 0 0 2px #333; pointer-events: none; }

    .color-palette-buttons { display: flex; flex-direction: column; gap: 4px; align-items: center; }
    .palette-color-btn { width: 32px; height: 32px; border: none; cursor: pointer; position: relative; }
    .palette-color-btn:hover { box-shadow: 0 0 5px rgba(0,0,0,0.3); }
    .palette-color-btn.selected { border: 2px solid #333; }

  /* Bottom-left toast */
  #toast-container { position: fixed; left: 10px; bottom: 10px; z-index: 9999; display: flex; flex-direction: column; gap: 6px; }
  /* Visual state for active place tool */
  #tools-panel .location-buttons button.selected { outline: 2px solid #2e7d32; border-radius: 4px; }

  /* Visual state for active place tool */
  #tools-panel .location-buttons button.selected { outline: 2px solid #2e7d32; border-radius: 4px; }

    /* Bottom-left rotation toggle */
    #rotation-panel {
      position: fixed;
      left: 10px;
      bottom: 70px; /* space above toast */
      z-index: 9999;
      background: rgba(255,255,255,0.9);
      padding: 6px 8px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      user-select: none;
    }
    #rotation-toggle-btn {
      font-family: Arial, sans-serif;
      font-size: 12px;
      line-height: 18px;
      padding: 4px 8px;
      border: 1px solid #bbb;
      border-radius: 3px;
      background: #f7f7f7;
      cursor: pointer;
    }
    #rotation-toggle-btn.on { background: #2e7d32; color: #fff; border-color: #2e7d32; }
    #rotation-toggle-btn.off { background: #b71c1c; color: #fff; border-color: #b71c1c; }
  </style>
</head>
<body>
  <!-- Drawing panel -->
  <div class="control-panel" id="drawing-panel">
    <div class="location-buttons">
      <button id="draw-btn" style="padding:0;border:none;background:none;">
        <img id="draw-btn-img" src="image/IconDrawingG.jpg" alt="Freehand Draw" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="clear-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconClearG.jpg" alt="Clear Drawings" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="undo-btn" style="padding:0;border:none;background:none;">
        <img id="undo-btn-img" src="image/IconUndoG.jpg" alt="Undo" style="width:32px;height:32px;vertical-align:middle;opacity:0.5;">
      </button>
      <button id="move-btn" style="padding:0;border:none;background:none;">
        <img id="move-btn-img" src="image/IconMoveG.jpg" alt="Move" style="width:32px;height:32px;vertical-align:middle;">
      </button>
    </div>
  </div>

  <!-- Tools panel -->
  <div class="control-panel" id="tools-panel">
    <div class="location-buttons">
      <button id="measure-btn" style="padding:0;border:none;background:none;">
        <img id="measure-btn-img" src="image/IconRulerG.jpg" alt="Measure Distance" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="tank-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconTankG.jpg" alt="Tank Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="uav-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconUAVG.jpg" alt="UAV Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="jetfighter-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconJetFighterG.jpg" alt="JetFighter Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="helicopter-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconHelicopterG.jpg" alt="Helicopter Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="submarine-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconSubmarineG.jpg" alt="Submarine Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="battleship-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconBattleshipG.jpg" alt="Battleship Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="select-mode-btn" title="Select units" style="padding:0;border:none;background:none;width:32px;height:32px;line-height:32px;text-align:center;">
        <img id="select-mode-btn-img" src="image/IconSelectRectangleG.jpg" alt="Select Units" style="width:32px;height:32px;vertical-align:middle;">
      </button>
    </div>
  </div>

  <!-- Map panel: memorize/go locations 1-5 -->
  <div class="control-panel" id="map-panel">
    <div class="location-buttons">
      <button class="location-btn" id="location-1"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-1" style="padding:0;border:none;width:32px;height:32px;"><span class="map-btn-num" id="location-num-1">1</span></span></button>
      <button class="location-btn" id="location-2"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-2" style="padding:0;width:32px;height:32px;"><span class="map-btn-num" id="location-num-2">2</span></span></button>
      <button class="location-btn" id="location-3"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-3" style="padding:0;width:32px;height:32px;"><span class="map-btn-num" id="location-num-3">3</span></span></button>
      <button class="location-btn" id="location-4"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-4" style="padding:0;width:32px;height:32px;"><span class="map-btn-num" id="location-num-4">4</span></span></button>
      <button class="location-btn" id="location-5"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-5" style="padding:0;width:32px;height:32px;"><span class="map-btn-num" id="location-num-5">5</span></span></button>
    </div>
  </div>

  <!-- Mode panel -->
  <div class="control-panel" id="mode-panel">
    <div class="mode-switch">
      <button id="mode-memorize" style="padding:0;border:none;background:none;outline:none;">
        <img id="mode-memorize-img" src="image/IconSaveL.jpg" alt="Memorize Mode" style="width:40px;height:40px;vertical-align:middle;">
      </button>
      <button id="mode-go" style="padding:0;border:none;background:none;outline:none;">
        <img id="mode-go-img" src="image/IconGotoMapG.jpg" alt="Go Mode" style="width:40px;height:40px;vertical-align:middle;">
      </button>
    </div>
  </div>

  <!-- Color palette for drawing -->
  <div class="control-panel" id="color-palette-panel" style="top: 80px; right: 130px; width: 40px; display: none;">
    <div class="color-palette-buttons">
      <button class="palette-color-btn" data-color="#ff0000" title="Red" style="background:#ff0000;width:32px;height:32px;border:none;margin-bottom:4px;"></button>
      <button class="palette-color-btn" data-color="#00ff00" title="Green" style="background:#00ff00;width:32px;height:32px;border:none;margin-bottom:4px;"></button>
      <button class="palette-color-btn" data-color="#0000ff" title="Blue" style="background:#0000ff;width:32px;height:32px;border:none;margin-bottom:4px;"></button>
      <button class="palette-color-btn" data-color="#000000" title="Black" style="background:#000000;width:32px;height:32px;border:none;margin-bottom:4px;"></button>
      <button class="palette-color-btn" data-color="#ffffff" title="White" style="background:#ffffff;width:32px;height:32px;border:1px solid #ccc;margin-bottom:4px;"></button>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast-container"></div>

  <!-- Rotation toggle (bottom-left) -->
  <div id="rotation-panel">
    <button id="rotation-toggle-btn" class="off" title="Toggle map rotation">Rotation: Off</button>
  </div>

  <!-- Debug panel (bottom-right) -->
  <div id="debug-panel" style="position:absolute;right:10px;bottom:10px;width:320px;max-height:40%;overflow:auto;background:rgba(0,0,0,0.7);color:#0f0;font:12px/1.4 monospace;padding:6px;border-radius:4px;z-index:2000;"></div>

  <div id="map"></div>

  <script type="module">
    import Map from 'https://cdn.skypack.dev/ol/Map';
    import View from 'https://cdn.skypack.dev/ol/View';
    import TileLayer from 'https://cdn.skypack.dev/ol/layer/Tile';
    import XYZ from 'https://cdn.skypack.dev/ol/source/XYZ';
    import VectorLayer from 'https://cdn.skypack.dev/ol/layer/Vector';
    import VectorSource from 'https://cdn.skypack.dev/ol/source/Vector';
    import Feature from 'https://cdn.skypack.dev/ol/Feature';
    import {LineString, Point} from 'https://cdn.skypack.dev/ol/geom';
    import {Stroke, Style, Circle as CircleStyle, Fill, Icon} from 'https://cdn.skypack.dev/ol/style';
    import Overlay from 'https://cdn.skypack.dev/ol/Overlay';
    import {fromLonLat, toLonLat} from 'https://cdn.skypack.dev/ol/proj';
    import {getLength as getGeodesicLength} from 'https://cdn.skypack.dev/ol/sphere';
    import DragPan from 'https://cdn.skypack.dev/ol/interaction/DragPan';
    import MouseWheelZoom from 'https://cdn.skypack.dev/ol/interaction/MouseWheelZoom';
    import DoubleClickZoom from 'https://cdn.skypack.dev/ol/interaction/DoubleClickZoom';
    import PinchZoom from 'https://cdn.skypack.dev/ol/interaction/PinchZoom';
    import KeyboardPan from 'https://cdn.skypack.dev/ol/interaction/KeyboardPan';
    import KeyboardZoom from 'https://cdn.skypack.dev/ol/interaction/KeyboardZoom';
    import DragZoom from 'https://cdn.skypack.dev/ol/interaction/DragZoom';
  import DragRotate from 'https://cdn.skypack.dev/ol/interaction/DragRotate';
  import PinchRotate from 'https://cdn.skypack.dev/ol/interaction/PinchRotate';

    // Toast helper
    function showToast(message, timeoutMs = 2000) {
      const c = document.getElementById('toast-container');
      if (!c) return;
      const el = document.createElement('div');
      el.textContent = message;
      el.style.cssText = 'background:rgba(0,0,0,0.85);color:#fff;padding:6px 10px;border-radius:3px;font-family:Arial, sans-serif;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,0.3);max-width:280px;';
      c.appendChild(el);
      setTimeout(() => { try { c.removeChild(el); } catch(_){} }, timeoutMs);
    }

    // On-screen debug logger
    function debug(msg) {
      const panel = document.getElementById('debug-panel');
      if (!panel) { console.log('[DBG]', msg); return; }
      const t = new Date();
      const hh = String(t.getHours()).padStart(2,'0');
      const mm = String(t.getMinutes()).padStart(2,'0');
      const ss = String(t.getSeconds()).padStart(2,'0');
      const ms = String(t.getMilliseconds()).padStart(3,'0');
      const line = document.createElement('div');
      line.textContent = `${hh}:${mm}:${ss}.${ms} ${msg}`;
      panel.appendChild(line);
      // Trim to last 150 lines
      while (panel.childNodes.length > 150) panel.removeChild(panel.firstChild);
      panel.scrollTop = panel.scrollHeight;
      try { console.log('[DBG]', msg); } catch(_){}
    }

    // Map setup (Esri World Imagery)
    // Resilient XYZ source with retries and larger cache to reduce white tiles
    const xyzSource = new XYZ({
      url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      maxZoom: 19,
      attributions: 'Tiles Â© Esri',
      crossOrigin: 'anonymous',
      cacheSize: 4096,
      wrapX: true
    });

    // Retry tile loading on transient failures (up to 3 attempts with backoff)
    const _retryCounts = new WeakMap();
    function resilientTileLoad(tile, src) {
      const img = tile.getImage();
      let n = _retryCounts.get(img) || 0;
      img.crossOrigin = 'anonymous';
      img.onload = () => { _retryCounts.delete(img); };
      img.onerror = () => {
        if (n < 3) {
          n += 1;
          _retryCounts.set(img, n);
          const delay = 300 * Math.pow(2, n - 1); // 300ms, 600ms, 1200ms
          setTimeout(() => { try { img.src = src; } catch(_){} }, delay);
        } else {
          // Keep interim tile; give up after retries
        }
      };
      img.src = src;
    }
    xyzSource.setTileLoadFunction(resilientTileLoad);

    const base = new TileLayer({
      source: xyzSource,
      preload: Infinity,
      useInterimTilesOnError: true,
      opacity: 1
    });

    const drawSource = new VectorSource();
    const drawLayer = new VectorLayer({ source: drawSource });
    const tempSource = new VectorSource();
    const tempLayer = new VectorLayer({ source: tempSource });
    const markerSource = new VectorSource();
    const markerLayer = new VectorLayer({ source: markerSource });
    const measureSource = new VectorSource();
    const measureLayer = new VectorLayer({ source: measureSource });

    const map = new Map({
      target: 'map',
      layers: [base, drawLayer, tempLayer, markerLayer, measureLayer],
      view: new View({ center: fromLonLat([0, 0]), zoom: 2 }),
      loadTilesWhileAnimating: true,
      loadTilesWhileInteracting: true
    });

    // Track interactions for easy toggling
    const interactions = {
      dragPan: map.getInteractions().getArray().find(i => i instanceof DragPan) || new DragPan(),
      wheelZoom: map.getInteractions().getArray().find(i => i instanceof MouseWheelZoom) || new MouseWheelZoom(),
      dblClickZoom: map.getInteractions().getArray().find(i => i instanceof DoubleClickZoom) || new DoubleClickZoom(),
      pinchZoom: map.getInteractions().getArray().find(i => i instanceof PinchZoom) || new PinchZoom(),
      keyPan: map.getInteractions().getArray().find(i => i instanceof KeyboardPan) || new KeyboardPan(),
      keyZoom: map.getInteractions().getArray().find(i => i instanceof KeyboardZoom) || new KeyboardZoom(),
      dragZoom: map.getInteractions().getArray().find(i => i instanceof DragZoom) || new DragZoom()
    };

    function setInteractionsActive(active) {
      Object.values(interactions).forEach(i => { try { i.setActive(active); } catch(_){} });
    }

    // Disable event leakage from panels into map
    ['drawing-panel','tools-panel','map-panel','mode-panel','color-palette-panel','toast-container','rotation-panel'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      ['pointerdown','pointermove','pointerup','click','wheel','touchstart','touchmove','touchend'].forEach(ev => {
        el.addEventListener(ev, e => { e.stopPropagation(); }, { passive: false });
      });
    });

    // Rotation controls
    const ri = map.getInteractions().getArray();
    let dragRotate = ri.find(i => i instanceof DragRotate) || null;
    let pinchRotate = ri.find(i => i instanceof PinchRotate) || null;
    // If rotate interactions are missing (unlikely), add them so we can toggle
    if (!dragRotate) { dragRotate = new DragRotate(); map.addInteraction(dragRotate); }
    if (!pinchRotate) { pinchRotate = new PinchRotate(); map.addInteraction(pinchRotate); }
    let rotationEnabled = false; // default off
    function applyRotationEnabled() {
      const on = !!rotationEnabled;
      if (dragRotate) dragRotate.setActive(on);
      if (pinchRotate) pinchRotate.setActive(on);
      if (!on) { try { map.getView().setRotation(0); } catch(_){} }
      const b = document.getElementById('rotation-toggle-btn');
      if (b) {
        b.textContent = 'Rotation: ' + (on ? 'On' : 'Off');
        b.classList.toggle('on', on);
        b.classList.toggle('off', !on);
      }
  debug('[rotation] enabled=' + on);
    }
    applyRotationEnabled();

    // State
    let moveActive = false;
    let drawingMode = false;
    let measuring = false;
    let placeMode = null; // 'tank' | 'uav' | ...
    let isDrawing = false;
    let currentCoords = [];
    let tempLine = null;
    let penColor = '#ff0000';
    const drawHistory = []; // Features for undo (lines or markers)
    let lastTouchTime = 0;
    let currentMode = 'memorize';

    // Styles
    function strokeStyle(color = '#ffffff', width = 3, dash = null) {
      return new Style({
        stroke: new Stroke({ color, width, lineCap: 'round', lineJoin: 'round', lineDash: dash || undefined })
      });
    }
    function pointStyle(color = '#ffffff') {
      return new Style({
        image: new CircleStyle({ radius: 4, fill: new Fill({ color: '#000000' }), stroke: new Stroke({ color, width: 1 }) })
      });
    }
    function iconStyle(url) {
      return new Style({ image: new Icon({ src: url, scale: 1, anchor: [0.5, 0.5] }) });
    }

    // Global error surface to debug panel
    window.addEventListener('error', (e) => {
      debug('[error] ' + e.message + ' at ' + e.filename + ':' + e.lineno + ':' + e.colno);
    });
    window.addEventListener('unhandledrejection', (e) => {
      debug('[promise] unhandled rejection: ' + (e.reason && e.reason.message ? e.reason.message : e.reason));
    });

    // Helpers that were referenced by the UI code
    function updateMoveIcon() {
      const moveImg = document.getElementById('move-btn-img');
      if (moveImg) moveImg.src = moveActive ? 'image/IconMoveL.jpg' : 'image/IconMoveG.jpg';
  debug('[ui] move icon -> ' + (moveActive ? 'active(L)' : 'inactive(G)'));
    }
    function updateMapLockByTools() {
      const allowPanZoom = !!moveActive; // Locked unless Move is active
      setInteractionsActive(allowPanZoom);
      try { map.getViewport().style.touchAction = allowPanZoom ? 'auto' : 'none'; } catch(_){}
      debug('[map] interactions ' + (allowPanZoom ? 'ENABLED' : 'DISABLED'));
    }

    // Mode helpers
    function getActiveRadioTool() {
      if (drawingMode) return 'draw';
      if (moveActive) return 'move';
      if (measuring) return 'measure';
      if (placeMode) return 'place:' + placeMode;
      return null;
    }
    function deactivateAllRadioTools() {
      // Drawing off
      if (drawingMode) stopFreehandDraw();
      const drawImg = document.getElementById('draw-btn-img');
      if (drawImg) { drawImg.src = 'image/IconDrawingG.jpg'; }
      // Measure off
      if (measuring) stopMeasuring();
      const mImg = document.getElementById('measure-btn-img');
      if (mImg) mImg.src = 'image/IconRulerG.jpg';
      // Place off
      if (placeMode) clearPlaceMode();
      // Move off
      moveActive = false; updateMoveIcon();
      updateMapLockByTools();
      const palettePanel = document.getElementById('color-palette-panel');
      if (palettePanel) palettePanel.style.display = 'none';
    }
    function setRadioTool(tool) {
  debug('[tool] request ' + tool);
      const cur = getActiveRadioTool();
      if (cur === tool) { deactivateAllRadioTools(); return; }
      deactivateAllRadioTools();
      switch (tool) {
        case 'draw':
          startFreehandDraw();
          document.getElementById('draw-btn-img').src = 'image/IconDrawingL.jpg';
          document.getElementById('color-palette-panel').style.display = 'block';
          debug('[tool] draw enabled');
          break;
        case 'move':
          moveActive = true; updateMoveIcon();
          debug('[tool] move enabled');
          break;
        case 'measure':
          startMeasuring();
          document.getElementById('measure-btn-img').src = 'image/IconRulerL.jpg';
          debug('[tool] measure enabled');
          break;
        case 'place:tank': case 'place:uav': case 'place:jetfighter': case 'place:helicopter': case 'place:submarine': case 'place:battleship':
          placeMode = tool.split(':')[1];
          updatePlaceButtons();
          updateMapLockByTools();
          debug('[tool] place mode -> ' + placeMode);
          break;
      }
      updateMapLockByTools();
    }

    // ========= Drawing helpers =========
    function startFreehandDraw() {
      drawingMode = true;
      isDrawing = false;
      currentCoords = [];
      try { map.getViewport().style.touchAction = 'none'; } catch(_){}
      debug('[draw] startFreehandDraw');
    }
    function stopFreehandDraw() {
      drawingMode = false;
      isDrawing = false;
      currentCoords = [];
      tempSource.clear();
      debug('[draw] stopFreehandDraw');
    }

    // ========= Measure helpers =========
    let measurePoints = [];
    function startMeasuring() {
      measuring = true;
      measurePoints = [];
      measureSource.clear();
      debug('[measure] start');
    }
    function stopMeasuring() {
      measuring = false;
      measurePoints = [];
      debug('[measure] stop');
    }
    function updateMeasure() {
      // Redraw polyline
      measureSource.clear();
      if (measurePoints.length < 2) return;
      const line = new LineString(measurePoints);
      const f = new Feature({ geometry: line });
      f.setStyle(strokeStyle('#ffeb3b', 3, [8,4]));
      measureSource.addFeature(f);
      // Compute geodesic length
      try {
        const coords4326 = measurePoints.map(c => toLonLat(c));
        const ll = new LineString(coords4326);
        const meters = getGeodesicLength(ll);
        debug('[measure] length m=' + meters.toFixed(1));
      } catch(_){}
    }

    // Ensure place mode can be cleared safely during deactivation
    function clearPlaceMode() {
      placeMode = null;
      updatePlaceButtons();
      updateMapLockByTools();
      debug('[tool] place mode cleared');
    }

    function updatePlaceButtons() {
      const defs = [
        ['tank','IconTankG.jpg','IconTankL.jpg'],
        ['uav','IconUAVG.jpg','IconUAVL.jpg'],
        ['jetfighter','IconJetFighterG.jpg','IconJetFighterL.jpg'],
        ['helicopter','IconHelicopterG.jpg','IconHelicopterL.jpg'],
        ['submarine','IconSubmarineG.jpg','IconSubmarineL.jpg'],
        ['battleship','IconBattleshipG.jpg','IconBattleshipL.jpg']
      ];
      defs.forEach(([id, gSrc, lSrc]) => {
        const btn = document.getElementById(id + '-btn');
        if (!btn) return;
        const img = btn.querySelector('img');
        const active = placeMode === id;
        btn.classList.toggle('selected', active);
        if (img) img.src = 'image/' + (active ? lSrc : gSrc);
      });
    }

    // Place marker with icon fallback: circle first, then swap to first available image
    function placeIconWithFallback(kind, coordinate) {
      const f = new Feature({ geometry: new Point(coordinate) });
      // Immediate visible placeholder
      f.setStyle(new Style({ image: new CircleStyle({ radius: 8, fill: new Fill({ color: '#ffee00' }), stroke: new Stroke({ color: '#333', width: 2 }) }) }));
      markerSource.addFeature(f);
      drawHistory.push(f);
      const undoImg = document.getElementById('undo-btn-img');
      if (undoImg) undoImg.style.opacity = '1';

      const candidatesMap = {
        tank: [ 'image/IconTankMap.png', 'image/IconTankM.png', 'image/IconTank.png', 'image/IconTankMap.jpg', 'image/IconTankM.jpg' ],
        uav: [ 'image/IconUAVMap.png', 'image/IconUAVM.png', 'image/IconUAV.png', 'image/IconUAVMap.jpg' ],
        jetfighter: [ 'image/IconJetFighterMap.png', 'image/IconJetFighterM.png', 'image/IconJetFighter.png', 'image/IconJetFighterMap.jpg', 'image/IconJetFighterM.jpg' ],
        helicopter: [ 'image/IconHelicopterMap.gif', 'image/IconHelicopterMap.png', 'image/IconHelicopterM.png', 'image/IconHelicopter.png', 'image/IconHelicopterMap.jpg' ],
        submarine: [ 'image/IconSubmarineMap.png', 'image/IconSubmarineM.png', 'image/IconSubmarine.png', 'image/IconSubmarineMap.jpg' ],
        battleship: [ 'image/IconBattleshipMap.png', 'image/IconBattleshipM.png', 'image/IconBattleship.png', 'image/IconBattleshipMap.jpg' ]
      };
      const list = candidatesMap[kind] || [];
      if (!list.length) { debug('[place] no icon candidates for ' + kind); return; }

      let idx = 0;
      const tryNext = () => {
        if (idx >= list.length) { debug('[place] no icon found for ' + kind + ' (kept circle placeholder)'); return; }
        const url = list[idx++];
        const img = new Image();
        img.onload = () => {
          debug('[place] using icon for ' + kind + ': ' + url);
          f.setStyle(iconStyle(url));
        };
        img.onerror = () => { debug('[place] missing icon tried: ' + url); tryNext(); };
        img.src = url;
      };
      tryNext();
    }

    // Allow touch-origin clicks during place/measure; otherwise keep ghost-click guard
    map.on('click', (evt) => {
      try {
        const ll = toLonLat(evt.coordinate);
  debug('[map] click lon=' + ll[0].toFixed(5) + ' lat=' + ll[1].toFixed(5) + ' measuring=' + measuring + ' place=' + (placeMode || 'none'));
      } catch(_) { debug('[map] click (unable to project)'); }
      if (!measuring && !placeMode && (Date.now() - lastTouchTime < 250)) return;
      if (measuring) {
        measurePoints.push(evt.coordinate);
        updateMeasure();
        return;
      }
      if (placeMode) {
        placeIconWithFallback(placeMode, evt.coordinate);
        debug('[place] requested place: ' + placeMode);
      }
    });

    // Extra low-level signals to check input delivery and implement draw/place fallback
    let lastDownPixel = null;
    map.on('pointerdown', (evt) => {
      const oe = evt.originalEvent || {};
  debug('[map] pointerdown type=' + (oe.type||'') + ' pointerType=' + (oe.pointerType||'') + ' buttons=' + ((oe.buttons!=null?oe.buttons:(oe.button!=null?oe.button:''))));
      lastDownPixel = evt.pixel ? evt.pixel.slice ? evt.pixel.slice() : [evt.pixel[0], evt.pixel[1]] : null;
      // Drawing start
      if (drawingMode) {
        isDrawing = true;
        currentCoords = [evt.coordinate];
        tempSource.clear();
        const tempFeat = new Feature({ geometry: new LineString(currentCoords) });
        tempFeat.setStyle(strokeStyle(penColor, 2, [6,3]));
        tempSource.addFeature(tempFeat);
      }
    });
    map.on('pointermove', (evt) => {
      if (drawingMode && isDrawing) {
        currentCoords.push(evt.coordinate);
        const feats = tempSource.getFeatures();
        if (feats.length > 0) {
          feats[0].getGeometry().setCoordinates(currentCoords);
        }
      }
    });
    map.on('pointerup', (evt) => {
      const oe = evt.originalEvent || {};
  debug('[map] pointerup type=' + (oe.type||'') + ' pointerType=' + (oe.pointerType||'') + ' buttons=' + ((oe.buttons!=null?oe.buttons:(oe.button!=null?oe.button:''))));
      // Complete drawing
      if (drawingMode && isDrawing) {
        isDrawing = false;
        if (currentCoords.length > 1) {
          const line = new LineString(currentCoords);
          const f = new Feature({ geometry: line });
          f.setStyle(strokeStyle(penColor, 3));
          drawSource.addFeature(f);
          drawHistory.push(f);
          const undoImg = document.getElementById('undo-btn-img');
          if (undoImg) undoImg.style.opacity = '1';
        }
        tempSource.clear();
      }

      // Place on pointerup as a fallback if click wasn't fired
      if (placeMode) {
        let smallMove = true;
        if (lastDownPixel && evt.pixel) {
          const dx = evt.pixel[0] - lastDownPixel[0];
          const dy = evt.pixel[1] - lastDownPixel[1];
          smallMove = (dx*dx + dy*dy) <= 25; // 5px threshold
        }
        if (smallMove) {
          placeIconWithFallback(placeMode, evt.coordinate);
          debug('[place] pointerup fallback place: ' + placeMode);
        }
      }
    });

    // Track touch starts on viewport explicitly
    try {
      map.getViewport().addEventListener('touchstart', (e) => {
        lastTouchTime = Date.now();
  debug('[viewport] touchstart touches=' + (e.touches ? e.touches.length : 0));
      }, { passive: true });
    } catch(_) {}

    // Buttons wiring
    document.getElementById('draw-btn').onclick = () => { debug('[ui] draw-btn click'); setRadioTool('draw'); };
    document.getElementById('move-btn').onclick = () => { debug('[ui] move-btn click'); setRadioTool('move'); };
    document.getElementById('measure-btn').onclick = () => { debug('[ui] measure-btn click'); setRadioTool('measure'); };
    document.getElementById('select-mode-btn').onclick = () => { debug('[ui] select-mode click'); showToast('Select mode not implemented on this OL page yet'); };
    document.getElementById('rotation-toggle-btn').onclick = () => {
      rotationEnabled = !rotationEnabled;
      applyRotationEnabled();
  debug('[ui] rotation-toggle click -> ' + (rotationEnabled ? 'On' : 'Off'));
      showToast('Map rotation ' + (rotationEnabled ? 'enabled' : 'disabled'));
    };

  const tankBtn = document.getElementById('tank-btn'); if (tankBtn) tankBtn.onclick = () => { debug('[ui] tank-btn click'); setRadioTool('place:tank'); };
  const uavBtn = document.getElementById('uav-btn'); if (uavBtn) uavBtn.onclick = () => { debug('[ui] uav-btn click'); setRadioTool('place:uav'); };
  const jetBtn = document.getElementById('jetfighter-btn'); if (jetBtn) jetBtn.onclick = () => { debug('[ui] jetfighter-btn click'); setRadioTool('place:jetfighter'); };
  const heliBtn = document.getElementById('helicopter-btn'); if (heliBtn) heliBtn.onclick = () => { debug('[ui] helicopter-btn click'); setRadioTool('place:helicopter'); };
  const subBtn = document.getElementById('submarine-btn'); if (subBtn) subBtn.onclick = () => { debug('[ui] submarine-btn click'); setRadioTool('place:submarine'); };
  const battleBtn = document.getElementById('battleship-btn'); if (battleBtn) battleBtn.onclick = () => { debug('[ui] battleship-btn click'); setRadioTool('place:battleship'); };

    // Palette buttons
    document.querySelectorAll('.palette-color-btn').forEach(btn => {
      btn.onclick = () => {
        penColor = btn.getAttribute('data-color');
        document.querySelectorAll('.palette-color-btn').forEach(b => b.style.outline = '');
        btn.style.outline = '2px solid #333';
      };
    });

    // Clear and Undo wiring
    const clearBtn = document.getElementById('clear-btn');
    if (clearBtn) clearBtn.onclick = () => {
      drawSource.clear();
      tempSource.clear();
      markerSource.clear();
      measureSource.clear();
      drawHistory.length = 0;
      const undoImg = document.getElementById('undo-btn-img');
      if (undoImg) undoImg.style.opacity = '0.5';
      debug('[ui] clear all');
    };
    const undoBtn = document.getElementById('undo-btn');
    if (undoBtn) undoBtn.onclick = () => {
      const f = drawHistory.pop();
      if (!f) { debug('[ui] undo: nothing'); return; }
      try { drawSource.removeFeature(f); } catch(_){}
      try { markerSource.removeFeature(f); } catch(_){}
      try { measureSource.removeFeature(f); } catch(_){}
      const undoImg = document.getElementById('undo-btn-img');
      if (undoImg) undoImg.style.opacity = drawHistory.length ? '1' : '0.5';
      debug('[ui] undo last');
    };

    // Memorize/Go logic (localStorage)
    function loadMemorized() {
      try {
        const saved = localStorage.getItem('ol_memorizedLocations');
        if (saved) return JSON.parse(saved);
      } catch(_) {}
      return [null,null,null,null,null];
    }
    function saveMemorized(arr) {
      localStorage.setItem('ol_memorizedLocations', JSON.stringify(arr));
    }
    let memorized = loadMemorized();

    function updateLocationButtons() {
      for (let i = 1; i <= 5; i++) {
        const img = document.getElementById('location-img-' + i);
        const isMem = !!memorized[i-1];
        if (currentMode === 'memorize') img.src = 'image/IconMapR.jpg';
        else img.src = isMem ? 'image/IconMapL.jpg' : 'image/IconMapG.jpg';
        const btn = document.getElementById('location-' + i);
        btn.style.opacity = currentMode === 'go' && !isMem ? '0.5' : '1';
      }
      saveMemorized(memorized);
    }
    function setMode(mode) {
      currentMode = mode;
      updateLocationButtons();
      if (mode === 'memorize') {
        document.getElementById('mode-memorize-img').src = 'image/IconSaveL.jpg';
        document.getElementById('mode-go-img').src = 'image/IconGotoMapG.jpg';
      } else {
        document.getElementById('mode-memorize-img').src = 'image/IconSaveG.jpg';
        document.getElementById('mode-go-img').src = 'image/IconGotoMapL.jpg';
      }
    }
    document.getElementById('mode-memorize').onclick = () => setMode('memorize');
    document.getElementById('mode-go').onclick = () => setMode('go');

    function memorize(idx) {
      const center3857 = map.getView().getCenter();
      const zoom = map.getView().getZoom();
      const center4326 = toLonLat(center3857);
      memorized[idx] = { center: { lon: center4326[0], lat: center4326[1] }, zoom, timestamp: new Date().toLocaleString() };
      updateLocationButtons();
  showToast('Saved Location ' + (idx+1));
    }
    function goTo(idx) {
      const loc = memorized[idx];
      if (!loc) { alert('No location memorized for ' + (idx+1)); return; }
      map.getView().animate({ center: fromLonLat([loc.center.lon, loc.center.lat]), zoom: loc.zoom, duration: 2000 });
    }
    for (let i = 1; i <= 5; i++) {
      document.getElementById('location-' + i).onclick = () => {
        if (currentMode === 'memorize') memorize(i-1); else goTo(i-1);
      };
    }
    updateLocationButtons();

  // Initialize
  document.getElementById('draw-btn').onclick = () => { debug('[init] (late) draw-btn bound -> draw'); setRadioTool('draw'); };
  document.getElementById('move-btn').onclick = () => { debug('[init] (late) move-btn bound -> move'); setRadioTool('move'); };

    // Start with map locked (not moving) until Move is turned on
    updateMapLockByTools();
  </script>
</body>
</html>
