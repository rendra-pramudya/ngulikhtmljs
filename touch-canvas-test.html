<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Touch Canvas Test (Paint-like)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #1e1e1e;
      font-family: Arial, sans-serif;
    }
    #map {
      position: fixed;
      inset: 0;
      z-index: 0;
    }
    #toolbar {
      position: fixed;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.96);
      padding: 8px 10px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      z-index: 10;
    }
    .swatches {
      display: flex;
      gap: 6px;
    }
    .swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #333;
      box-sizing: border-box;
      cursor: pointer;
    }
    .swatch.selected {
      border-color: #0078d4;
      box-shadow: 0 0 0 2px rgba(0,120,212,0.35);
    }
    .sep { width: 1px; height: 28px; background: #ddd; margin: 0 4px; }
    #widthLabel { font-size: 12px; color: #333; margin-left: 4px; }
    #widthRange { width: 120px; }
    button.tool {
      height: 28px;
      padding: 0 10px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      border-radius: 4px;
      cursor: pointer;
    }
    button.tool:active { transform: translateY(1px); }
    #canvasWrap {
      position: fixed;
      inset: 0;
      z-index: 1;
    }
    canvas {
      width: 100vw;
      height: 100vh;
      display: block;
      background: transparent; /* show map underlay */
      cursor: crosshair;
      touch-action: none; /* consistent touch when drawing enabled */
    }
    /* Panels copied from world-satellite-map.html */
    .control-panel {
      position: absolute;
      z-index: 1000;
      right: 400px;
      top: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      margin: 0;
    }
    .map-btn-img { position: relative; display: inline-block; width: 32px; height: 32px; }
    .map-btn-img img { width: 32px; height: 32px; display: block; }
    .map-btn-num { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.3em; font-weight: bold; color: white; text-shadow: 0 0 4px #000, 0 0 2px #333; pointer-events: none; }
    .other-buttons { display: flex; flex-direction: column; gap: 0px; align-items: flex-start; margin-top: 10px; }
    .other-buttons button { display: flex; align-items: center; width: 48px; height: 48px; padding: 0; border: none; border-radius: 0px; background: none; cursor: pointer; }
    .other-buttons button:hover { background-color: #7f8c8d; }
    #drawing-panel { top: 80px; right: 70px; width: 32px; }
    #mode-panel { top: 10px; right: 10px; width: 92px; }
    #map-panel { top: 80px; right: 10px; width: 50px; padding: 0; }
    #map-panel .location-buttons { display: block; flex-direction: column; align-items: center; gap: 40px; margin: 0; padding: 0; align-items: center; justify-content: center; }
    #map-panel .location-btn { width: 50px; height: 50px; padding: 0; border: none; background: none; display: flex; align-items: center; justify-content: center; }
    #map-panel .map-btn-img, #map-panel .map-btn-img img { width: 32px; height: 32px; display: block; }
  </style>
</head>
<body>
  <!-- Panels copied from world-satellite-map.html -->
  <div class="control-panel" id="drawing-panel">
    <div class="location-buttons">
      <button id="draw-btn" style="padding:0;border:none;background:none;">
        <img id="draw-btn-img" src="image/IconDrawingG.jpg" alt="Freehand Draw" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="clear-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconClearG.jpg" alt="Clear Drawings" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="undo-btn" style="padding:0;border:none;background:none;">
        <img id="undo-btn-img" src="image/IconUndoG.jpg" alt="Undo" style="width:32px;height:32px;vertical-align:middle;opacity:0.5;">
      </button>
      <button id="move-btn" style="padding:0;border:none;background:none;">
        <img id="move-btn-img" src="image/IconMoveG.jpg" alt="Move" style="width:32px;height:32px;vertical-align:middle;">
      </button>
    </div>
  </div>

  <div class="control-panel" id="tools-panel" style="top: 235px; right: 70px; width: 32px;">
    <div class="location-buttons">
      <button id="measure-btn" style="padding:0;border:none;background:none;">
        <img id="measure-btn-img" src="image/IconRulerG.jpg" alt="Measure Distance" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="tank-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconTankG.jpg" alt="Tank Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="uav-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconUAVG.jpg" alt="UAV Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="jetfighter-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconJetFighterG.jpg" alt="JetFighter Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="helicopter-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconHelicopterG.jpg" alt="Helicopter Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="submarine-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconSubmarineG.jpg" alt="Submarine Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="battleship-btn" style="padding:0;border:none;background:none;">
        <img src="image/IconBattleshipG.jpg" alt="Battleship Icon" style="width:32px;height:32px;vertical-align:middle;">
      </button>
      <button id="select-mode-btn" title="Select units" style="padding:0;border:none;background:none;width:32px;height:32px;line-height:32px;text-align:center;">
        <img id="select-mode-btn-img" src="image/IconSelectRectangleG.jpg" alt="Select Units" style="width:32px;height:32px;vertical-align:middle;">
      </button>
    </div>
  </div>

  <div class="control-panel" id="map-panel">
    <div class="location-buttons" >
      <button class="location-btn" id="location-1"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-1" style="padding:0;border:none;width:32px;height:32px;"><span class="map-btn-num" id="location-num-1">1</span></span></button>
      <button class="location-btn" id="location-2"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-2" style="padding:0;width:32px;height:32px;"><span class="map-btn-num" id="location-num-2">2</span></span></button>
      <button class="location-btn" id="location-3"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-3" style="padding:0;width:32px;height:32px;"><span class="map-btn-num" id="location-num-3">3</span></span></button>
      <button class="location-btn" id="location-4"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-4" style="padding:0;width:32px;height:32px;"><span class="map-btn-num" id="location-num-4">4</span></span></button>
      <button class="location-btn" id="location-5"><span class="map-btn-img"><img src="image/IconMapG.jpg" id="location-img-5" style="padding:0;width:32px;height:32px;"><span class="map-btn-num" id="location-num-5">5</span></span></button>
    </div>
  </div>
  <!-- Bottom-left toast container -->
  <div id="toast-container" style="position:fixed;left:10px;bottom:10px;z-index:9999;display:flex;flex-direction:column;gap:6px;"></div>

  <div class="control-panel" id="mode-panel">
    <div class="mode-switch">
      <button id="mode-memorize" style="padding:0;border:none;background:none;outline:none;">
        <img id="mode-memorize-img" src="image/IconSaveL.jpg" alt="Memorize Mode" style="width:40px;height:40px;vertical-align:middle;">
      </button>
      <button id="mode-go" style="padding:0;border:none;background:none;outline:none;">
        <img id="mode-go-img" src="image/IconGotoMapG.jpg" alt="Go Mode" style="width:40px;height:40px;vertical-align:middle;">
      </button>
    </div>
  </div>
  <div id="toolbar">
    <div class="swatches" id="swatches"></div>
    <div class="sep"></div>
    <label id="widthLabel">Width</label>
    <input id="widthRange" type="range" min="1" max="40" value="4" />
    <div class="sep"></div>
    <button id="undoBtn" class="tool">Undo</button>
    <button id="clearBtn" class="tool">Clear</button>
    <button id="importBtn" class="tool" title="Import from URL hash or clipboard">Import</button>
    <div class="sep"></div>
    <button id="moveBtn" class="tool" title="Toggle map movement">
      <img id="moveBtnImg" src="image/IconMoveG.jpg" alt="Move" style="width:20px;height:20px;vertical-align:middle;" />
    </button>
  </div>
  <div id="map"></div>
  <div id="canvasWrap">
    <canvas id="draw"></canvas>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize Leaflet map (satellite imagery)
    const map = L.map('map', { zoomControl: true }).setView([0, 0], 2);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Tiles Â© Esri'
    }).addTo(map);

    // Device pixel ratio scaling for crisp strokes
    const canvas = document.getElementById('draw');
    const ctx = canvas.getContext('2d');
  const dpr = Math.max(1, window.devicePixelRatio || 1);

    // Geolocated strokes: store LatLngs and project for rendering
    // stroke: { color, width, latlngs: [{lat,lng}] }
  let strokes = [];
  let currentStroke = null; // same structure
  let activePointerId = null;
  const activePointers = new Set();
    let currentColor = '#ff0000';
    let currentWidth = 4;
    let moveEnabled = false; // when true: map can pan/zoom, drawing disabled

  // Primary colors only
  const COLORS = ['#ff0000','#00ff00','#0000ff'];

    // Build color swatches
    const swWrap = document.getElementById('swatches');
    let swatchEls = [];
    COLORS.forEach((c, i) => {
      const el = document.createElement('div');
      el.className = 'swatch' + (i === 0 ? ' selected' : '');
      el.style.background = c;
      el.title = c;
      el.addEventListener('click', () => selectColor(c, el));
      swWrap.appendChild(el);
      swatchEls.push(el);
    });
    function selectColor(color, el) {
      currentColor = color;
      swatchEls.forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');
    }

    // Width slider
    const widthRange = document.getElementById('widthRange');
    widthRange.addEventListener('input', () => {
      currentWidth = parseInt(widthRange.value, 10) || 4;
    });

    // Undo and Clear
    document.getElementById('undoBtn').addEventListener('click', () => {
      if (currentStroke) return; // do not undo mid-stroke
      strokes.pop();
      redrawAll();
    });
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (currentStroke) return;
      strokes = [];
      clearCanvas();
    });

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width * dpr));
      const h = Math.max(1, Math.floor(rect.height * dpr));
      canvas.width = w;
      canvas.height = h;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.imageSmoothingEnabled = true;
      redrawAll();
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function clientToLatLng(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      return map.containerPointToLatLng([x, y]);
    }

    // Note: two-finger pan/zoom is handled by toggling Move mode automatically.

    function latLngToCanvasXY(latlng) {
      const pt = map.latLngToContainerPoint(latlng);
      return { x: pt.x * dpr, y: pt.y * dpr };
    }

    function drawSegment(stroke, fromIdx) {
      const pts = stroke.latlngs;
      if (!pts || pts.length < 2) return;
      ctx.strokeStyle = stroke.color;
      ctx.lineWidth = stroke.width * dpr;
      // Draw only last segment for efficiency
      const i = Math.max(1, fromIdx);
      const p0 = latLngToCanvasXY(pts[i-1]);
      const p1 = latLngToCanvasXY(pts[i]);
      ctx.beginPath();
      ctx.moveTo(p0.x, p0.y);
      ctx.lineTo(p1.x, p1.y);
      ctx.stroke();
    }

    function redrawAll() {
      clearCanvas();
      for (const s of strokes) {
        if (!s.latlngs || s.latlngs.length < 2) continue;
        ctx.strokeStyle = s.color;
        ctx.lineWidth = s.width * dpr;
        const first = latLngToCanvasXY(s.latlngs[0]);
        ctx.beginPath();
        ctx.moveTo(first.x, first.y);
        for (let i = 1; i < s.latlngs.length; i++) {
          const p = latLngToCanvasXY(s.latlngs[i]);
          ctx.lineTo(p.x, p.y);
        }
        ctx.stroke();
      }
    }

    // Utilities: fit LatLng-like points into canvas coordinates
    function drawPathFromLatLngs(latlngs, color = currentColor, width = currentWidth) {
      if (!latlngs || latlngs.length < 2) return;
      const stroke = { color, width, latlngs: latlngs.map(p => ({ lat: p.lat, lng: p.lng })) };
      strokes.push(stroke);
      redrawAll();
    }

    function tryImportFromHash() {
      const hash = window.location.hash || '';
      const m = hash.match(/#path=([^&]+)/);
      if (!m) return false;
      try {
        const json = decodeURIComponent(m[1]);
        const obj = JSON.parse(json);
        if (obj && Array.isArray(obj.points) && obj.points.length >= 2) {
          drawPathFromLatLngs(obj.points);
          return true;
        }
      } catch (_) {}
      return false;
    }

    async function tryImportFromClipboard() {
      try {
        const text = await navigator.clipboard.readText();
        const obj = JSON.parse(text);
        if (obj && Array.isArray(obj.points) && obj.points.length >= 2) {
          drawPathFromLatLngs(obj.points);
          return true;
        }
      } catch (_) {}
      return false;
    }

    // Pointer events (mouse, touch, pen) with capture; gated by moveEnabled
    function setCanvasInteractivity() {
      // Drawing mode consumes single-pointer events; map mode lets events through
      const pe = moveEnabled ? 'none' : 'auto';
      canvas.style.pointerEvents = pe;
      canvas.style.cursor = moveEnabled ? 'grab' : 'crosshair';
    }

    canvas.addEventListener('pointerdown', (e) => {
      activePointers.add(e.pointerId);
      if (moveEnabled) return; // map mode
      // If a second pointer touches, switch to Move mode and stop drawing
      if (activePointers.size >= 2) {
        if (currentStroke && activePointerId != null) {
          try { canvas.releasePointerCapture(activePointerId); } catch (_) {}
          activePointerId = null;
          currentStroke = null;
        }
        setMoveEnabled(true); // enable map pan/zoom, disable drawing
        return;
      }
      if (activePointerId !== null) return; // already drawing
      canvas.setPointerCapture(e.pointerId);
      activePointerId = e.pointerId;
      const ll = clientToLatLng(e);
      currentStroke = { color: currentColor, width: currentWidth, latlngs: [ll] };
      strokes.push(currentStroke);
    }, { passive: false });

    canvas.addEventListener('pointermove', (e) => {
      if (moveEnabled) return;
      // Single-pointer drawing only
      if (activePointerId !== e.pointerId || !currentStroke) return;
      const ll = clientToLatLng(e);
      const pts = currentStroke.latlngs;
      const last = pts[pts.length - 1];
      if (!last || last.lat !== ll.lat || last.lng !== ll.lng) {
        pts.push(ll);
        drawSegment(currentStroke, pts.length - 1);
      }
    }, { passive: false });

    function endStroke(e) {
      if (activePointerId === e.pointerId) {
        try { canvas.releasePointerCapture(e.pointerId); } catch (_) {}
        activePointerId = null;
        currentStroke = null;
      }
      activePointers.delete(e.pointerId);
    }

    canvas.addEventListener('pointerup', endStroke, { passive: false });
    canvas.addEventListener('pointercancel', endStroke, { passive: false });
    // If the pointer leaves the canvas, end the stroke gracefully
    canvas.addEventListener('pointerout', (e) => {
      if (activePointerId === e.pointerId) endStroke(e);
      else { activePointers.delete(e.pointerId); }
    }, { passive: false });

    function setMoveEnabled(flag) {
      moveEnabled = flag;
      const img = document.getElementById('moveBtnImg');
      // Icon legend: G = Move enabled (Go), L = Move locked (drawing)
      if (img) img.src = moveEnabled ? 'image/IconMoveG.jpg' : 'image/IconMoveL.jpg';
      // Also update panel icon if present
      const panelImg = document.getElementById('move-btn-img');
      if (panelImg) panelImg.src = moveEnabled ? 'image/IconMoveG.jpg' : 'image/IconMoveL.jpg';
      // Update draw button visual
      const drawImg = document.getElementById('draw-btn-img');
      if (drawImg) drawImg.src = moveEnabled ? 'image/IconDrawingG.jpg' : 'image/IconDrawingL.jpg';
      if (moveEnabled) {
        map.dragging.enable();
        if (map.touchZoom) map.touchZoom.enable();
        map.doubleClickZoom.enable();
        map.scrollWheelZoom.enable();
        map.boxZoom.enable();
        map.keyboard.enable();
      } else {
        map.dragging.disable();
        if (map.touchZoom) map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.scrollWheelZoom.disable();
        map.boxZoom.disable();
        map.keyboard.disable();
      }
      setCanvasInteractivity();
    }

    document.getElementById('moveBtn').addEventListener('click', () => {
      setMoveEnabled(!moveEnabled);
    });

    // Wire up panel buttons to canvas drawing logic
    const panelMoveBtn = document.getElementById('move-btn');
    if (panelMoveBtn) {
      panelMoveBtn.addEventListener('click', () => setMoveEnabled(!moveEnabled));
    }
    const panelDrawBtn = document.getElementById('draw-btn');
    if (panelDrawBtn) {
      panelDrawBtn.addEventListener('click', () => setMoveEnabled(false)); // enter drawing mode
    }
    const panelClearBtn = document.getElementById('clear-btn');
    if (panelClearBtn) {
      panelClearBtn.addEventListener('click', () => {
        if (currentStroke) return;
        strokes = [];
        clearCanvas();
        const undoImg = document.getElementById('undo-btn-img');
        if (undoImg) undoImg.style.opacity = '0.5';
      });
    }
    const panelUndoBtn = document.getElementById('undo-btn');
    if (panelUndoBtn) {
      panelUndoBtn.addEventListener('click', () => {
        if (currentStroke) return;
        if (strokes.length > 0) {
          strokes.pop();
          redrawAll();
        }
        const undoImg = document.getElementById('undo-btn-img');
        if (undoImg) undoImg.style.opacity = strokes.length > 0 ? '1' : '0.5';
      });
    }

    // Optional: simple placeholders for other tool buttons
    function toast(msg) {
      const c = document.getElementById('toast-container');
      if (!c) return;
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.cssText = 'background:rgba(0,0,0,0.85);color:#fff;padding:6px 10px;border-radius:3px;font-family:Arial, sans-serif;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,0.3);max-width:280px;';
      c.appendChild(el);
      setTimeout(() => { try { c.removeChild(el); } catch(_){} }, 1500);
    }
    ['measure-btn','tank-btn','uav-btn','jetfighter-btn','helicopter-btn','submarine-btn','battleship-btn','select-mode-btn','mode-memorize','mode-go','location-1','location-2','location-3','location-4','location-5']
      .forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('click', () => toast('Not implemented on this page')); });

    // On wheel while drawing, switch to Move and perform the zoom
    canvas.addEventListener('wheel', (e) => {
      if (moveEnabled) return; // map will receive wheel when canvas is inert
      e.preventDefault();
      setMoveEnabled(true); // disable drawing
      // Perform the zoom for this event
      const rect = map.getContainer().getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top;
      const centerLL = map.containerPointToLatLng([x, y]);
      const cur = map.getZoom();
      const delta = e.deltaY;
      if (!isFinite(delta) || delta === 0) return;
      const step = (e.deltaMode === 1 /* line */) ? 0.25 : (e.deltaMode === 2 /* page */) ? 1 : 0.25;
      const dir = delta < 0 ? 1 : -1;
      const newZoom = cur + dir * step;
      if (typeof map.setZoomAround === 'function') {
        map.setZoomAround(centerLL, newZoom, { animate: false });
      } else {
        map.setView(centerLL, newZoom, { animate: false });
      }
    }, { passive: false });

    // Initial setup
    window.addEventListener('resize', resizeCanvas);
    map.on('move zoom zoomend resize', redrawAll);
    resizeCanvas();
    setMoveEnabled(false); // default to drawing mode (Move disabled)

    // Auto-import if path provided in URL hash
    window.addEventListener('load', () => { tryImportFromHash(); });
    document.getElementById('importBtn').addEventListener('click', async () => {
      if (tryImportFromHash()) return;
      await tryImportFromClipboard();
    });
  </script>
</body>
</html>
